<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×“×™×§×ª ×—×™×‘×•×¨ - Royal Cash</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #121212;
            color: #F5F5DC;
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 5px;
        }
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        button {
            background: #D4AF37;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ×‘×“×™×§×ª ×—×™×‘×•×¨ - Royal Cash</h1>
    <button onclick="runAllTests()">×”×¨×¥ ××ª ×›×œ ×”×‘×“×™×§×•×ª</button>
    <div id="results"></div>

    <script>
        const SUPABASE_URL = window.SUPABASE_URL || 'https://gfchswspvayyvdlxbggw.supabase.co';
        const SUPABASE_KEY = window.SUPABASE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmY2hzd3NwdmF5eXZkbHhiZ2d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDI1NTUsImV4cCI6MjA3OTM3ODU1NX0.5vIkcgyGEWEW3uI5Y2bJKG7Ex2uhIAsUtC8US6BFVtA';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const resultsDiv = document.getElementById('results');

        function addResult(title, status, message, data = null) {
            const div = document.createElement('div');
            div.className = 'test-item';
            const statusClass = status === 'success' ? 'success' : status === 'error' ? 'error' : 'warning';
            div.innerHTML = `
                <h3 class="${statusClass}">${status === 'success' ? 'âœ…' : status === 'error' ? 'âŒ' : 'âš ï¸'} ${title}</h3>
                <p>${message}</p>
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            resultsDiv.appendChild(div);
        }

        async function testConfig() {
            addResult('×‘×“×™×§×ª ×”×’×“×¨×•×ª', 'info', '×‘×•×“×§ ××ª ×”×”×’×“×¨×•×ª...');
            
            if (!SUPABASE_URL || SUPABASE_URL.includes('undefined')) {
                addResult('×‘×“×™×§×ª URL', 'error', 'SUPABASE_URL ×œ× ××•×’×“×¨!');
                return false;
            }
            
            if (!SUPABASE_KEY || SUPABASE_KEY.includes('undefined')) {
                addResult('×‘×“×™×§×ª Key', 'error', 'SUPABASE_KEY ×œ× ××•×’×“×¨!');
                return false;
            }
            
            addResult('×‘×“×™×§×ª URL', 'success', `SUPABASE_URL: ${SUPABASE_URL}`);
            addResult('×‘×“×™×§×ª Key', 'success', `SUPABASE_KEY: ${SUPABASE_KEY.substring(0, 20)}...`);
            return true;
        }

        async function testConnection() {
            addResult('×‘×“×™×§×ª ×—×™×‘×•×¨', 'info', '×‘×•×“×§ ×—×™×‘×•×¨ ×œ-Supabase...');
            
            try {
                const { data, error } = await supabase.from('profiles').select('count').limit(1);
                
                if (error) {
                    addResult('×‘×“×™×§×ª ×—×™×‘×•×¨', 'error', `×©×’×™××”: ${error.message}`, error);
                    return false;
                }
                
                addResult('×‘×“×™×§×ª ×—×™×‘×•×¨', 'success', '×”×—×™×‘×•×¨ ×œ-Supabase ×¢×•×‘×“!');
                return true;
            } catch (err) {
                addResult('×‘×“×™×§×ª ×—×™×‘×•×¨', 'error', `×©×’×™××”: ${err.message}`, err);
                return false;
            }
        }

        async function testTables() {
            addResult('×‘×“×™×§×ª ×˜×‘×œ××•×ª', 'info', '×‘×•×“×§ ××ª ×”×˜×‘×œ××•×ª...');
            
            const tables = ['profiles', 'tables', 'table_players', 'game_results'];
            const results = {};
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase.from(table).select('*').limit(1);
                    if (error) {
                        results[table] = { status: 'error', message: error.message };
                    } else {
                        results[table] = { status: 'success', count: data ? data.length : 0 };
                    }
                } catch (err) {
                    results[table] = { status: 'error', message: err.message };
                }
            }
            
            let allGood = true;
            for (const [table, result] of Object.entries(results)) {
                if (result.status === 'error') {
                    addResult(`×˜×‘×œ×”: ${table}`, 'error', result.message);
                    allGood = false;
                } else {
                    addResult(`×˜×‘×œ×”: ${table}`, 'success', `× ×’×™×©×” (${result.count} ×©×•×¨×•×ª ×œ×“×•×’××”)`);
                }
            }
            
            return allGood;
        }

        async function testTrigger() {
            addResult('×‘×“×™×§×ª ×˜×¨×™×’×¨', 'info', '×‘×•×“×§ ××ª ×”×˜×¨×™×’×¨...');
            
            try {
                // Check if trigger exists by trying to query game_results
                const { data, error } = await supabase
                    .from('game_results')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    addResult('×‘×“×™×§×ª ×˜×¨×™×’×¨', 'warning', `×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ×™×©×™×¨×•×ª. ×‘×“×•×§ ×‘-SQL Editor: SELECT * FROM pg_trigger WHERE tgname = 'on_game_result_insert';`);
                    return false;
                }
                
                addResult('×‘×“×™×§×ª ×˜×¨×™×’×¨', 'warning', '×”×˜×¨×™×’×¨ ×œ× × ×™×ª×Ÿ ×œ×‘×“×™×§×” ×™×©×™×¨×•×ª. ×‘×“×•×§ ×‘-SQL Editor: SELECT * FROM pg_trigger WHERE tgname = \'on_game_result_insert\';');
                return true;
            } catch (err) {
                addResult('×‘×“×™×§×ª ×˜×¨×™×’×¨', 'error', `×©×’×™××”: ${err.message}`);
                return false;
            }
        }

        async function testProfiles() {
            addResult('×‘×“×™×§×ª ×¤×¨×•×¤×™×œ×™×', 'info', '×‘×•×“×§ ××ª ×”×¤×¨×•×¤×™×œ×™×...');
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, username, total_profit, games_played')
                    .limit(5);
                
                if (error) {
                    addResult('×‘×“×™×§×ª ×¤×¨×•×¤×™×œ×™×', 'error', `×©×’×™××”: ${error.message}`, error);
                    return false;
                }
                
                if (!data || data.length === 0) {
                    addResult('×‘×“×™×§×ª ×¤×¨×•×¤×™×œ×™×', 'warning', '××™×Ÿ ×¤×¨×•×¤×™×œ×™× ×‘××¢×¨×›×ª');
                    return true;
                }
                
                // Check if columns exist
                const hasTotalProfit = data.some(p => 'total_profit' in p);
                const hasGamesPlayed = data.some(p => 'games_played' in p);
                
                if (!hasTotalProfit) {
                    addResult('×‘×“×™×§×ª ×¢××•×“×•×ª ×¤×¨×•×¤×™×œ×™×', 'error', '×”×¢××•×“×” total_profit ×œ× ×§×™×™××ª! ×”×¨×¥ ××ª ultimate_fix.sql');
                } else {
                    addResult('×‘×“×™×§×ª ×¢××•×“×•×ª ×¤×¨×•×¤×™×œ×™×', 'success', '×”×¢××•×“×” total_profit ×§×™×™××ª');
                }
                
                if (!hasGamesPlayed) {
                    addResult('×‘×“×™×§×ª ×¢××•×“×•×ª ×¤×¨×•×¤×™×œ×™×', 'error', '×”×¢××•×“×” games_played ×œ× ×§×™×™××ª! ×”×¨×¥ ××ª ultimate_fix.sql');
                } else {
                    addResult('×‘×“×™×§×ª ×¢××•×“×•×ª ×¤×¨×•×¤×™×œ×™×', 'success', '×”×¢××•×“×” games_played ×§×™×™××ª');
                }
                
                addResult('×‘×“×™×§×ª ×¤×¨×•×¤×™×œ×™×', 'success', `× ××¦××• ${data.length} ×¤×¨×•×¤×™×œ×™×`, data);
                return true;
            } catch (err) {
                addResult('×‘×“×™×§×ª ×¤×¨×•×¤×™×œ×™×', 'error', `×©×’×™××”: ${err.message}`, err);
                return false;
            }
        }

        async function testTablePlayers() {
            addResult('×‘×“×™×§×ª ×©×—×§× ×™× ×‘×©×•×œ×—× ×•×ª', 'info', '×‘×•×“×§ ××ª ×©×—×§× ×™ ×”×©×•×œ×—× ×•×ª...');
            
            try {
                const { data, error } = await supabase
                    .from('table_players')
                    .select('id, user_id, cash_out, net_profit')
                    .limit(10);
                
                if (error) {
                    addResult('×‘×“×™×§×ª ×©×—×§× ×™× ×‘×©×•×œ×—× ×•×ª', 'error', `×©×’×™××”: ${error.message}`, error);
                    return false;
                }
                
                if (!data || data.length === 0) {
                    addResult('×‘×“×™×§×ª ×©×—×§× ×™× ×‘×©×•×œ×—× ×•×ª', 'warning', '××™×Ÿ ×©×—×§× ×™× ×‘×©×•×œ×—× ×•×ª');
                    return true;
                }
                
                // Check for invalid user_ids
                const invalidUsers = data.filter(p => 
                    p.user_id === 'null' || 
                    (p.user_id !== null && typeof p.user_id === 'string' && p.user_id.trim() === '')
                );
                
                if (invalidUsers.length > 0) {
                    addResult('×‘×“×™×§×ª user_id', 'error', `× ××¦××• ${invalidUsers.length} ×©×—×§× ×™× ×¢× user_id ×œ× ×ª×§×™×Ÿ!`, invalidUsers);
                } else {
                    addResult('×‘×“×™×§×ª user_id', 'success', '×›×œ ×”-user_id ×ª×§×™× ×™×');
                }
                
                addResult('×‘×“×™×§×ª ×©×—×§× ×™× ×‘×©×•×œ×—× ×•×ª', 'success', `× ××¦××• ${data.length} ×©×—×§× ×™×`, data.slice(0, 3));
                return true;
            } catch (err) {
                addResult('×‘×“×™×§×ª ×©×—×§× ×™× ×‘×©×•×œ×—× ×•×ª', 'error', `×©×’×™××”: ${err.message}`, err);
                return false;
            }
        }

        async function runAllTests() {
            resultsDiv.innerHTML = '';
            addResult('×”×ª×—×œ×ª ×‘×“×™×§×•×ª', 'info', '××ª×—×™×œ ××ª ×›×œ ×”×‘×“×™×§×•×ª...');
            
            const configOk = await testConfig();
            if (!configOk) {
                addResult('×¡×™×›×•×', 'error', '×”×‘×“×™×§×•×ª × ×›×©×œ×• - ×™×© ×‘×¢×™×” ×‘×”×’×“×¨×•×ª!');
                return;
            }
            
            const connectionOk = await testConnection();
            if (!connectionOk) {
                addResult('×¡×™×›×•×', 'error', '×”×‘×“×™×§×•×ª × ×›×©×œ×• - ××™×Ÿ ×—×™×‘×•×¨ ×œ-Supabase!');
                return;
            }
            
            await testTables();
            await testProfiles();
            await testTablePlayers();
            await testTrigger();
            
            addResult('×¡×™×›×•×', 'success', '×›×œ ×”×‘×“×™×§×•×ª ×”×•×©×œ××•! ×‘×“×•×§ ××ª ×”×ª×•×¦××•×ª ×œ××¢×œ×”.');
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            addResult('××™×“×¢', 'info', '×œ×—×¥ ×¢×œ "×”×¨×¥ ××ª ×›×œ ×”×‘×“×™×§×•×ª" ×›×“×™ ×œ×”×ª×—×™×œ');
        });
    </script>
</body>
</html>


